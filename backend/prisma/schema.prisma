// Prisma Schema para Sistema de Asistencias

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  COLABORADOR
  PRACTICANTE
  ADMIN
}

enum QRType {
  IN
  OUT
}

enum ShiftType {
  AM
  PM
}

enum AttendanceStatus {
  PRESENTE
  TARDE
  FALTA
  JUSTIFICADO
}

// Modelos

model User {
  id           String   @id @default(uuid())
  employeeCode String   @unique @map("employee_code")
  loginCode    String   @unique @map("login_code") // Código de 4 caracteres para login
  email        String? // Opcional (sin @unique para permitir múltiples NULL)
  fullName     String   @map("full_name")
  role         UserRole @default(COLABORADOR)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  attendances AttendanceRecord[]
  auditLogs   AuditLog[]

  schedules UserSchedule[]

  @@map("users")
}

model Location {
  id           Int      @id @default(autoincrement())
  name         String
  address      String?
  latitude     Decimal  @db.Decimal(10, 8)
  longitude    Decimal  @db.Decimal(11, 8)
  radiusMeters Int      @default(100) @map("radius_meters")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")

  qrCodes QRCode[]

  @@map("locations")
}

model QRCode {
  id         Int       @id @default(autoincrement())
  qrToken    String    @unique @default(uuid()) @map("qr_token")
  qrDate     DateTime? @map("qr_date") @db.Date
  qrType     QRType    @map("qr_type")
  shift      ShiftType
  locationId Int       @map("location_id")
  validFrom  DateTime  @map("valid_from")
  validUntil DateTime  @map("valid_until")
  isFixed    Boolean   @default(false) @map("is_fixed")
  createdAt  DateTime  @default(now()) @map("created_at")

  location    Location           @relation(fields: [locationId], references: [id])
  attendances AttendanceRecord[]
  auditLogs   AuditLog[]

  @@unique([qrDate, qrType, shift])
  @@index([qrToken])
  @@index([qrDate, shift])
  @@map("qr_codes")
}

model UserSchedule {
  id        Int       @id @default(autoincrement())
  userId    String    @map("user_id")
  dayOfWeek Int // 1=Lunes, 6=Sábado
  shift     ShiftType
  startTime String?   @map("start_time") // Ej: "09:00"
  endTime   String?   @map("end_time") // Ej: "13:00"
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, dayOfWeek, shift])
  @@map("user_schedules")
}

model AttendanceRecord {
  id                Int              @id @default(autoincrement())
  userId            String           @map("user_id")
  qrId              Int?             @map("qr_id")
  attendanceDate    DateTime         @map("attendance_date") @db.Date
  shift             ShiftType
  checkInTime       DateTime?        @map("check_in_time")
  checkInLat        Decimal?         @map("check_in_lat") @db.Decimal(10, 8)
  checkInLng        Decimal?         @map("check_in_lng") @db.Decimal(11, 8)
  checkInAccuracyM  Decimal?         @map("check_in_accuracy_m") @db.Decimal(6, 2)
  checkOutTime      DateTime?        @map("check_out_time")
  checkOutLat       Decimal?         @map("check_out_lat") @db.Decimal(10, 8)
  checkOutLng       Decimal?         @map("check_out_lng") @db.Decimal(11, 8)
  checkOutAccuracyM Decimal?         @map("check_out_accuracy_m") @db.Decimal(6, 2)
  lateMinutes       Int              @default(0) @map("late_minutes")
  discountAmount    Decimal          @default(0.00) @map("discount_amount") @db.Decimal(6, 2)
  status            AttendanceStatus @default(PRESENTE)
  discountApplied   Boolean          @default(false) @map("discount_applied")

  // Justification fields
  isJustified         Boolean @default(false) @map("is_justified")
  justificationReason String? @map("justification_reason")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User    @relation(fields: [userId], references: [id])
  qr   QRCode? @relation(fields: [qrId], references: [id])

  @@unique([userId, attendanceDate, shift])
  @@index([attendanceDate, shift])
  @@index([userId, attendanceDate])
  @@map("attendance_records")
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  userId    String?  @map("user_id")
  qrId      Int?     @map("qr_id")
  action    String
  reason    String?
  latitude  Decimal? @db.Decimal(10, 8)
  longitude Decimal? @db.Decimal(11, 8)
  accuracyM Decimal? @map("accuracy_m") @db.Decimal(6, 2)
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  user User?   @relation(fields: [userId], references: [id])
  qr   QRCode? @relation(fields: [qrId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}
